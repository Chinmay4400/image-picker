"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(function(){var ImagePicker,ImagePickerOption,both_array_are_equal,sanitized_options,indexOf=[].indexOf;jQuery.fn.extend({imagepicker:function(){var opts=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return this.each(function(){var select;if((select=jQuery(this)).data("picker")&&select.data("picker").destroy(),select.data("picker",new ImagePicker(this,sanitized_options(opts))),null!=opts.initialized)return opts.initialized.call(select.data("picker"))})}}),sanitized_options=function(opts){var default_options;return default_options={auto_update:!1,hide_select:!0,show_label:!1,initialized:void 0,changed:void 0,clicked:void 0,selected:void 0,limit:void 0,limit_reached:void 0,font_awesome:!1},jQuery.extend(default_options,opts)},both_array_are_equal=function(a,b){var i,j,len,x;if(!a||!b||a.length!==b.length)return!1;for(a=a.slice(0),b=b.slice(0),a.sort(),b.sort(),i=j=0,len=a.length;j<len;i=++j)if(x=a[i],b[i]!==x)return!1;return!0},ImagePicker=function(){function ImagePicker(select_element){var opts1=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,ImagePicker),this.sync_picker_with_select=this.sync_picker_with_select.bind(this),this.opts=opts1,this.select=jQuery(select_element),this.multiple="multiple"===this.select.attr("multiple"),null!=this.select.data("limit")&&(this.opts.limit=parseInt(this.select.data("limit"))),this.build_and_append_picker(),this.opts.auto_update&&this.setup_data_bind()}return _createClass(ImagePicker,[{key:"destroy",value:function(){var j,len,ref;for(j=0,len=(ref=this.picker_options).length;j<len;j++)ref[j].destroy();return this.picker.remove(),this.select.off("change",this.sync_picker_with_select),this.select.removeData("picker"),this.select.show()}},{key:"build_and_append_picker",value:function(){return this.opts.hide_select&&this.select.hide(),this.select.on("change",this.sync_picker_with_select),null!=this.picker&&this.picker.remove(),this.create_picker(),this.select.after(this.picker),this.sync_picker_with_select()}},{key:"setup_data_bind",value:function(){var context;context=this,new MutationObserver(function(mutations){return mutations.forEach(function(mutation){var j,k,len,len1,option,ref,ref1,results;for(j=0,len=(ref=mutation.addedNodes).length;j<len;j++)option=ref[j],context.add_option(option.index,option);for(results=[],k=0,len1=(ref1=mutation.removedNodes).length;k<len1;k++)option=ref1[k],results.push(context.remove_option(option));return results}),!0}).observe(jQuery(this.select).get(0),{childList:!0,subtree:!0})}},{key:"sync_picker_with_select",value:function(){var j,len,option,ref;for(j=0,len=(ref=this.picker_options).length;j<len;j++)(option=ref[j]).is_selected()?option.mark_as_selected():option.unmark_as_selected();jQuery("li",this.picker).each(function(){jQuery(this).hasClass("selected")&&0===jQuery("li",this.picker).find(":focus").length?jQuery(this).prop("tabindex","0"):jQuery(this).prop("tabindex","-1")}),0===jQuery(this).find(":selected").length&&0===jQuery("li",this.picker).find(":focus").length&&$("li:first-child",this.picker).find(".selectable").prop("tabindex","0")}},{key:"create_picker",value:function(){return this.picker=jQuery("<ul class='thumbnails image_picker_selector'></ul>"),this.picker_options=[],this.recursively_parse_option_groups(this.select,this.picker),this.picker}},{key:"add_option",value:function(index,option){var container,groupIndex,optGroup;container=this.picker,0<(optGroup=jQuery(option).parent("optgroup")).length&&(groupIndex=jQuery("optgroup",this.select).index(optGroup),container=jQuery(".group",this.picker).eq(groupIndex).first("ul")),(option=new ImagePickerOption(option,this,this.opts)).unmark_as_selected(),option.has_image()&&(this.picker_options.length===index?container.append(option.node):container.children().eq(index).before(option.node),this.picker_options.splice(index,0,option))}},{key:"remove_option",value:function(option){var i,j,ref,results,val;if(0!==this.picker_options.length){for(val=jQuery(option).val(),results=[],i=j=ref=this.picker_options.length-1;ref<=0?j<=0:0<=j;i=ref<=0?++j:--j)this.picker_options[i].value()===val?(this.picker_options[i].node.remove(),this.picker_options.splice(i,1),results.push(this.select.change())):results.push(void 0);return results}}},{key:"recursively_parse_option_groups",value:function(scoped_dom,target_container){var container,j,k,len,len1,option,option_group,ref,ref1,results;for(j=0,len=(ref=scoped_dom.children("optgroup")).length;j<len;j++)option_group=ref[j],option_group=jQuery(option_group),(container=jQuery("<ul></ul>")).append(jQuery("<li class='group_title'>"+option_group.attr("label")+"</li>")),target_container.append(jQuery("<li class='group'>").append(container)),this.recursively_parse_option_groups(option_group,container);for(results=[],k=0,len1=(ref1=function(){var l,len1,ref1,results1;for(results1=[],l=0,len1=(ref1=scoped_dom.children("option")).length;l<len1;l++)option=ref1[l],results1.push(new ImagePickerOption(option,this,this.opts));return results1}.call(this)).length;k<len1;k++)option=ref1[k],this.picker_options.push(option),option.has_image()&&results.push(target_container.append(option.node));return results}},{key:"has_implicit_blanks",value:function(){var option;return 0<function(){var j,len,ref,results;for(results=[],j=0,len=(ref=this.picker_options).length;j<len;j++)(option=ref[j]).is_blank()&&!option.has_image()&&results.push(option);return results}.call(this).length}},{key:"selected_values",value:function(){return this.multiple?this.select.val()||[]:[this.select.val()]}},{key:"toggle",value:function(imagepicker_option,original_event){var new_values,old_values,selected_value;if(old_values=this.selected_values(),selected_value=imagepicker_option.value().toString(),this.multiple?0<=indexOf.call(this.selected_values(),selected_value)?((new_values=this.selected_values()).splice(jQuery.inArray(selected_value,old_values),1),this.select.val([]),this.select.val(new_values)):null!=this.opts.limit&&this.selected_values().length>=this.opts.limit?null!=this.opts.limit_reached&&this.opts.limit_reached.call(this.select):this.select.val(this.selected_values().concat(selected_value)):this.has_implicit_blanks()&&imagepicker_option.is_selected()?this.select.val(""):this.select.val(selected_value),!both_array_are_equal(old_values,this.selected_values())&&(this.select.change(),null!=this.opts.changed))return this.opts.changed.call(this.select,old_values,this.selected_values(),original_event)}}]),ImagePicker}(),ImagePickerOption=function(){function ImagePickerOption(option_element,picker){var opts1=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};_classCallCheck(this,ImagePickerOption),this.clicked=this.clicked.bind(this),this.key_down=this.key_down.bind(this),this.picker=picker,this.opts=opts1,this.option=jQuery(option_element),this.create_node()}return _createClass(ImagePickerOption,[{key:"destroy",value:function(){return this.node.find(".thumbnail").off("click",this.clicked)}},{key:"has_image",value:function(){return null!=this.option.data("img-src")}},{key:"is_blank",value:function(){return!(null!=this.value()&&""!==this.value())}},{key:"is_selected",value:function(){var select_value;return select_value=this.picker.select.val(),this.picker.multiple?0<=jQuery.inArray(this.value(),select_value):this.value()===select_value}},{key:"mark_as_selected",value:function(){return this.node.find(".thumbnail").addClass("selected")}},{key:"unmark_as_selected",value:function(){return this.node.find(".thumbnail").removeClass("selected")}},{key:"value",value:function(){return this.option.val()}},{key:"label",value:function(){return this.option.data("img-label")?this.option.data("img-label"):this.option.text()}},{key:"clicked",value:function(event){if(this.picker.toggle(this,event),null!=this.opts.clicked&&this.opts.clicked.call(this.picker.select,this,event),null!=this.opts.selected&&this.is_selected())return this.opts.selected.call(this.picker.select,this,event)}},{key:"key_down",value:function(node,thumbnail){return function(event){0===event.which||32===event.which||13===event.which?(event.preventDefault(),thumbnail.click()):37===event.which||38===event.which?(event.preventDefault(),node.prev().find(".thumbnail>img").prop("tabindex","0"),node.prev().find(".thumbnail>img").focus()):39!==event.which&&40!==event.which||(event.preventDefault(),node.next().find(".thumbnail>img").prop("tabindex","0"),node.next().find(".thumbnail>img").focus())}}},{key:"create_node",value:function(){var image,imgAlt,imgClass,thumbnail;return this.node=jQuery("<li/>"),this.option.data("font_awesome")?(image=jQuery("<i>")).attr("class","fa-fw "+this.option.data("img-src")):(image=jQuery("<img class='image_picker_image' tabindex='0'/>")).attr("src",this.option.data("img-src")),thumbnail=jQuery("<div class='thumbnail'>"),(imgClass=this.option.data("img-class"))&&(this.node.addClass(imgClass),image.addClass(imgClass),thumbnail.addClass(imgClass)),(imgAlt=this.option.data("img-alt"))&&image.attr("alt",imgAlt),thumbnail.on("click",this.clicked),thumbnail.on("keydown",this.key_down(this.node,thumbnail)),thumbnail.on("focusout",function(event){var exitingCtrl;exitingCtrl=!$(this).siblings().is($(event.relatedTarget).closest("li")),$(this).closest("ul").find(".thumbnail").each(function(){$(this).hasClass("selected")&&exitingCtrl?$(this).prop("tabindex","0"):$(this).prop("tabindex","-1")}),0===$(this).closest("ul").find(".selected").length&&exitingCtrl&&$("li:first-child",$(this).closest("ul")).find(".thumbnail").prop("tabindex","0")}),thumbnail.on("focusin",function(){$(this).closest("ul").find(".thumbnail").each(function(){$(this).prop("tabindex","-1")})}),thumbnail.on("mousedown",function(event){event.preventDefault(),$(this).closest("ul").find(".thumbnail").each(function(){$(this).blur()})}),thumbnail.append(image),this.opts.show_label&&thumbnail.append(jQuery("<p/>").html(this.label())),this.node.append(thumbnail),this.node}}]),ImagePickerOption}()}).call(void 0);